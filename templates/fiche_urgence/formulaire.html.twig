{% extends 'base.html.twig' %}

{% block title %}Fiche d'urgence{% endblock %}

{% block body %}
<!-- Fil d'ariane -->
<nav class="fr-breadcrumb" aria-label="vous êtes ici :">
    <button class="fr-breadcrumb__button" aria-expanded="false" aria-controls="breadcrumb-fiche">Voir le fil d'Ariane</button>
    <div class="fr-collapse" id="breadcrumb-fiche">
        <ol class="fr-breadcrumb__list">
            <li><a class="fr-breadcrumb__link" href="{{ path('app_home') }}">Accueil</a></li>
            <li><a class="fr-breadcrumb__link" href="{{ path('app_mes_dossiers') }}">Mes dossiers</a></li>
            <li><a class="fr-breadcrumb__link" aria-current="page">Fiche d'urgence</a></li>
        </ol>
    </div>
</nav>

<!-- En-tête -->
<section class="fr-container fr-py-6v">
    <div class="fr-grid-row">
        <div class="fr-col-12">
            <h1 class="fr-h1">Fiche d'urgence</h1>
            <p class="fr-text--lead fr-mb-3v">
                Remplissez les informations nécessaires en cas d'urgence. Votre progression est sauvegardée automatiquement.
            </p>
            <div class="fr-alert fr-alert--info fr-mb-4v">
                <p class="fr-text--sm">Ces informations permettront de vous contacter rapidement en cas d'urgence et de connaître vos antécédents médicaux.</p>
            </div>
        </div>
    </div>
</section>

<!-- Indicateur de progression -->
<section class="fr-container fr-mb-4v">
    <div class="fr-stepper">
        <h2 class="fr-stepper__title">
            <span class="fr-stepper__state">Étape <span id="current-step">1</span> sur 4</span>
        </h2>
        <div class="fr-stepper__steps" data-fr-current-step="1" data-fr-steps="4"></div>
        <p class="fr-stepper__details">
            <span class="fr-text--bold" id="step-title">Identité</span>
        </p>
    </div>
</section>

<!-- Formulaire -->
<section class="fr-container fr-pb-6v">
    <form class="fr-form" id="ficheUrgenceForm" method="post">
        
        <!-- Étape 1: Identité et Responsable -->
        <div class="form-step" id="step-1">
            <div class="fr-card">
                <div class="fr-card__body">
                    <h2 class="fr-h2 fr-mb-3v">Informations de l'élève</h2>
                    <div class="fr-grid-row fr-grid-row--gutters">
                        <div class="fr-col-12 fr-col-md-6">
                            <div class="fr-input-group">
                                <label class="fr-label" for="nom_etudiant">Nom <span class="fr-text--red">*</span></label>
                                <input class="fr-input" type="text" id="nom_etudiant" name="nom_etudiant" value="{{ fiche.nomEtudiant }}" required>
                            </div>
                        </div>
                        <div class="fr-col-12 fr-col-md-6">
                            <div class="fr-input-group">
                                <label class="fr-label" for="prenom_etudiant">Prénom <span class="fr-text--red">*</span></label>
                                <input class="fr-input" type="text" id="prenom_etudiant" name="prenom_etudiant" value="{{ fiche.prenomEtudiant }}" required>
                            </div>
                        </div>
                    </div>
                    <div class="fr-grid-row fr-grid-row--gutters">
                        <div class="fr-col-12 fr-col-md-6">
                            <div class="fr-input-group">
                                <label class="fr-label" for="classe">Classe <span class="fr-text--red">*</span></label>
                                <input class="fr-input" type="text" id="classe" name="classe" value="{{ fiche.classe }}" placeholder="Ex: BTS CG 1ère année" required>
                            </div>
                        </div>
                        <div class="fr-col-12 fr-col-md-6">
                            <div class="fr-input-group">
                                <label class="fr-label" for="sexe">Sexe <span class="fr-text--red">*</span></label>
                                <select class="fr-select" id="sexe" name="sexe" required>
                                    <option value="" disabled>Sélectionner</option>
                                    <option value="M" {{ fiche.sexe == 'M' ? 'selected' : '' }}>Masculin</option>
                                    <option value="F" {{ fiche.sexe == 'F' ? 'selected' : '' }}>Féminin</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="fr-grid-row fr-grid-row--gutters">
                        <div class="fr-col-12 fr-col-md-6">
                            <div class="fr-input-group">
                                <label class="fr-label" for="date_naissance">Date de naissance <span class="fr-text--red">*</span></label>
                                <input class="fr-input" type="date" id="date_naissance" name="date_naissance" value="{{ fiche.dateNaissance ? fiche.dateNaissance|date('Y-m-d') : '' }}" required>
                            </div>
                        </div>
                    </div>

                    <h3 class="fr-h4 fr-mt-4w fr-mb-3v">Responsable légal</h3>
                    <div class="fr-input-group">
                        <label class="fr-label" for="nom_representant">Nom du responsable <span class="fr-text--red">*</span></label>
                        <input class="fr-input" type="text" id="nom_representant" name="nom_representant" value="{{ fiche.nomRepresentant }}" required>
                    </div>
                    <div class="fr-input-group">
                        <label class="fr-label" for="adresse_representant">Adresse du responsable <span class="fr-text--red">*</span></label>
                        <textarea class="fr-input" id="adresse_representant" name="adresse_representant" rows="3" required>{{ fiche.adresseRepresentant }}</textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- Étape 2: Assurances -->
        <div class="form-step" id="step-2" style="display: none;">
            <div class="fr-card fr-mb-3w">
                <div class="fr-card__body">
                    <h2 class="fr-h2 fr-mb-3v">Sécurité sociale</h2>
                    <div class="fr-input-group">
                        <label class="fr-label" for="centre_secu_nom">Nom du centre de sécurité sociale <span class="fr-text--red">*</span></label>
                        <input class="fr-input" type="text" id="centre_secu_nom" name="centre_secu_nom" value="{{ fiche.centreSecuNom }}" required>
                    </div>
                    <div class="fr-input-group">
                        <label class="fr-label" for="centre_secu_adresse">Adresse du centre <span class="fr-text--red">*</span></label>
                        <textarea class="fr-input" id="centre_secu_adresse" name="centre_secu_adresse" rows="3" required>{{ fiche.centreSecuAdresse }}</textarea>
                    </div>
                </div>
            </div>

            <div class="fr-card">
                <div class="fr-card__body">
                    <h2 class="fr-h2 fr-mb-3v">Assurance</h2>
                    <div class="fr-input-group">
                        <label class="fr-label" for="assurance_nom">Nom de l'assurance <span class="fr-text--red">*</span></label>
                        <input class="fr-input" type="text" id="assurance_nom" name="assurance_nom" value="{{ fiche.assuranceNom }}" required>
                    </div>
                    <div class="fr-input-group">
                        <label class="fr-label" for="assurance_adresse">Adresse de l'assurance <span class="fr-text--red">*</span></label>
                        <textarea class="fr-input" id="assurance_adresse" name="assurance_adresse" rows="3" required>{{ fiche.assuranceAdresse }}</textarea>
                    </div>
                    <div class="fr-input-group">
                        <label class="fr-label" for="assurance_numero">Numéro d'assurance <span class="fr-text--red">*</span></label>
                        <input class="fr-input" type="text" id="assurance_numero" name="assurance_numero" value="{{ fiche.assuranceNumero }}" required>
                    </div>
                </div>
            </div>
        </div>

        <!-- Étape 3: Contacts -->
        <div class="form-step" id="step-3" style="display: none;">
            <div class="fr-card fr-mb-3w">
                <div class="fr-card__body">
                    <h2 class="fr-h2 fr-mb-3v">Contacts - Père</h2>
                    <div class="fr-grid-row fr-grid-row--gutters">
                        <div class="fr-col-12 fr-col-md-6">
                            <div class="fr-input-group">
                                <label class="fr-label" for="pere_tel_domicile">Téléphone domicile <span class="fr-text--red">*</span></label>
                                <input class="fr-input" type="tel" id="pere_tel_domicile" name="pere_tel_domicile" value="{{ fiche.pereTelDomicile }}" placeholder="01 23 45 67 89" required>
                            </div>
                        </div>
                        <div class="fr-col-12 fr-col-md-6">
                            <div class="fr-input-group">
                                <label class="fr-label" for="pere_tel_travail">Téléphone travail <span class="fr-text--red">*</span></label>
                                <input class="fr-input" type="tel" id="pere_tel_travail" name="pere_tel_travail" value="{{ fiche.pereTelTravail }}" placeholder="01 23 45 67 89" required>
                            </div>
                        </div>
                    </div>
                    <div class="fr-grid-row fr-grid-row--gutters">
                        <div class="fr-col-12 fr-col-md-6">
                            <div class="fr-input-group">
                                <label class="fr-label" for="pere_tel_perso">Téléphone personnel <span class="fr-text--red">*</span></label>
                                <input class="fr-input" type="tel" id="pere_tel_perso" name="pere_tel_perso" value="{{ fiche.pereTelPerso }}" placeholder="06 12 34 56 78" required>
                            </div>
                        </div>
                        <div class="fr-col-12 fr-col-md-6">
                            <div class="fr-input-group">
                                <label class="fr-label" for="pere_poste">Poste/Profession <span class="fr-text--red">*</span></label>
                                <input class="fr-input" type="text" id="pere_poste" name="pere_poste" value="{{ fiche.perePoste }}" required>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="fr-card fr-mb-3w">
                <div class="fr-card__body">
                    <h2 class="fr-h2 fr-mb-3v">Contacts - Mère</h2>
                    <div class="fr-grid-row fr-grid-row--gutters">
                        <div class="fr-col-12 fr-col-md-6">
                            <div class="fr-input-group">
                                <label class="fr-label" for="mere_tel_travail">Téléphone travail <span class="fr-text--red">*</span></label>
                                <input class="fr-input" type="tel" id="mere_tel_travail" name="mere_tel_travail" value="{{ fiche.mereTelTravail }}" placeholder="01 23 45 67 89" required>
                            </div>
                        </div>
                        <div class="fr-col-12 fr-col-md-6">
                            <div class="fr-input-group">
                                <label class="fr-label" for="mere_tel_perso">Téléphone personnel <span class="fr-text--red">*</span></label>
                                <input class="fr-input" type="tel" id="mere_tel_perso" name="mere_tel_perso" value="{{ fiche.mereTelPerso }}" placeholder="06 12 34 56 78" required>
                            </div>
                        </div>
                    </div>
                    <div class="fr-input-group">
                        <label class="fr-label" for="mere_poste">Poste/Profession <span class="fr-text--red">*</span></label>
                        <input class="fr-input" type="text" id="mere_poste" name="mere_poste" value="{{ fiche.merePoste }}" required>
                    </div>
                </div>
            </div>

            <div class="fr-card">
                <div class="fr-card__body">
                    <h2 class="fr-h2 fr-mb-3v">Contact d'urgence</h2>
                    <div class="fr-grid-row fr-grid-row--gutters">
                        <div class="fr-col-12 fr-col-md-6">
                            <div class="fr-input-group">
                                <label class="fr-label" for="nom_contact_urgence">Nom du contact <span class="fr-text--red">*</span></label>
                                <input class="fr-input" type="text" id="nom_contact_urgence" name="nom_contact_urgence" value="{{ fiche.nomContactUrgence }}" required>
                            </div>
                        </div>
                        <div class="fr-col-12 fr-col-md-6">
                            <div class="fr-input-group">
                                <label class="fr-label" for="tel_contact_urgence">Téléphone du contact <span class="fr-text--red">*</span></label>
                                <input class="fr-input" type="tel" id="tel_contact_urgence" name="tel_contact_urgence" value="{{ fiche.telContactUrgence }}" placeholder="06 12 34 56 78" required>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Étape 4: Santé et Médecin -->
        <div class="form-step" id="step-4" style="display: none;">
            <div class="fr-card fr-mb-3w">
                <div class="fr-card__body">
                    <h2 class="fr-h2 fr-mb-3v">Informations médicales</h2>
                    <div class="fr-input-group">
                        <label class="fr-label" for="date_vaccin_antitetanique">Date du dernier rappel du vaccin antitétanique <span class="fr-text--red">*</span></label>
                        <input class="fr-input" type="date" id="date_vaccin_antitetanique" name="date_vaccin_antitetanique" value="{{ fiche.dateVaccinAntitetanique ? fiche.dateVaccinAntitetanique|date('Y-m-d') : '' }}" required>
                    </div>
                    <div class="fr-input-group">
                        <label class="fr-label" for="observation_etudiant">Observations particulières <span class="fr-text--red">*</span></label>
                        <textarea class="fr-input" id="observation_etudiant" name="observation_etudiant" rows="4" placeholder="Allergies, traitements en cours, précautions particulières..." required>{{ fiche.observationEtudiant }}</textarea>
                    </div>
                </div>
            </div>

            <div class="fr-card">
                <div class="fr-card__body">
                    <h2 class="fr-h2 fr-mb-3v">Médecin traitant</h2>
                    <div class="fr-input-group">
                        <label class="fr-label" for="medecin_nom">Nom du médecin <span class="fr-text--red">*</span></label>
                        <input class="fr-input" type="text" id="medecin_nom" name="medecin_nom" value="{{ fiche.medecinNom }}" required>
                    </div>
                    <div class="fr-input-group">
                        <label class="fr-label" for="medecin_adresse">Adresse du médecin <span class="fr-text--red">*</span></label>
                        <textarea class="fr-input" id="medecin_adresse" name="medecin_adresse" rows="3" required>{{ fiche.medecinAdresse }}</textarea>
                    </div>
                    <div class="fr-input-group">
                        <label class="fr-label" for="medecin_numero">Téléphone du médecin <span class="fr-text--red">*</span></label>
                        <input class="fr-input" type="tel" id="medecin_numero" name="medecin_numero" value="{{ fiche.medecinNumero }}" placeholder="01 23 45 67 89" required>
                    </div>
                </div>
            </div>
        </div>

        <!-- Boutons de navigation -->
        <div class="fr-btns-group fr-btns-group--inline-md fr-mt-4v">
            <button class="fr-btn fr-btn--secondary" type="button" id="prevBtn" style="display: none;">
                Étape précédente
            </button>
            <button class="fr-btn fr-btn--secondary" type="button" id="saveBtn">
                <span class="fr-icon-save-line fr-icon--sm" aria-hidden="true"></span>
                Sauvegarder et continuer plus tard
            </button>
            <button class="fr-btn" type="button" id="nextBtn">
                Étape suivante
            </button>
            <button class="fr-btn" type="submit" id="submitBtn" style="display: none;">
                Soumettre ma fiche d'urgence
            </button>
        </div>
    </form>
</section>

<script>
let currentStep = 1;
const totalSteps = 4;

function showStep(step) {
    // Masquer toutes les étapes
    document.querySelectorAll('.form-step').forEach(s => {
        s.style.display = 'none';
    });
    
    // Afficher l'étape courante
    const currentStepElement = document.getElementById('step-' + step);
    if (currentStepElement) {
        currentStepElement.style.display = 'block';
    }
    
    // Mettre à jour le stepper DSFR
    const stepper = document.querySelector('.fr-stepper__steps');
    if (stepper) {
        stepper.setAttribute('data-fr-current-step', step);
    }
    
    // Mettre à jour le texte du stepper
    const currentStepText = document.getElementById('current-step');
    if (currentStepText) {
        currentStepText.textContent = step;
    }
    
    // Mettre à jour le titre de l'étape
    const stepTitles = ['Identité', 'Assurances', 'Contacts', 'Santé et Médecin'];
    const stepTitle = document.getElementById('step-title');
    if (stepTitle && stepTitles[step - 1]) {
        stepTitle.textContent = stepTitles[step - 1];
    }
    
    // Gérer les boutons
    document.getElementById('prevBtn').style.display = step === 1 ? 'none' : 'inline-block';
    document.getElementById('nextBtn').style.display = step === totalSteps ? 'none' : 'inline-block';
    document.getElementById('submitBtn').style.display = step === totalSteps ? 'inline-block' : 'none';
    
    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// Fonction de validation d'une étape
function validateStep(step) {
    const stepElement = document.getElementById('step-' + step);
    if (!stepElement) return true;
    
    // Récupérer tous les champs obligatoires de l'étape
    const requiredFields = stepElement.querySelectorAll('[required]');
    let isValid = true;
    let emptyFields = [];
    
    requiredFields.forEach(field => {
        // Retirer les anciennes classes d'erreur
        field.classList.remove('fr-input--error', 'fr-select--error');
        const inputGroup = field.closest('.fr-input-group, .fr-select-group');
        if (inputGroup) {
            const errorMsg = inputGroup.querySelector('.fr-error-text');
            if (errorMsg) errorMsg.remove();
        }
        
        // Vérifier si le champ est vide
        if (!field.value || field.value.trim() === '') {
            isValid = false;
            
            // Ajouter la classe d'erreur
            if (field.tagName === 'SELECT') {
                field.classList.add('fr-select--error');
            } else {
                field.classList.add('fr-input--error');
            }
            
            // Récupérer le label pour le message d'erreur
            const label = field.closest('.fr-input-group, .fr-select-group')?.querySelector('label');
            const fieldName = label ? label.textContent.replace('*', '').trim() : 'Ce champ';
            emptyFields.push(fieldName);
        }
    });
    
    // Afficher un message d'erreur global si des champs sont vides
    if (!isValid) {
        // Supprimer l'ancien message d'erreur s'il existe
        const oldAlert = document.getElementById('validation-alert');
        if (oldAlert) oldAlert.remove();
        
        // Créer un nouveau message d'erreur
        const alert = document.createElement('div');
        alert.id = 'validation-alert';
        alert.className = 'fr-alert fr-alert--error fr-mb-3w';
        alert.innerHTML = `
            <p class="fr-alert__title">Champs obligatoires manquants</p>
            <p>Veuillez remplir tous les champs obligatoires avant de continuer :</p>
            <ul class="fr-text--sm">
                ${emptyFields.map(field => `<li>${field}</li>`).join('')}
            </ul>
        `;
        
        stepElement.insertBefore(alert, stepElement.firstChild);
        
        // Scroll vers le message d'erreur
        alert.scrollIntoView({ behavior: 'smooth', block: 'start' });
    } else {
        // Supprimer le message d'erreur s'il existe
        const oldAlert = document.getElementById('validation-alert');
        if (oldAlert) oldAlert.remove();
    }
    
    return isValid;
}

document.getElementById('nextBtn').addEventListener('click', function() {
    if (currentStep < totalSteps) {
        // Valider l'étape courante avant de passer à la suivante
        if (validateStep(currentStep)) {
            currentStep++;
            showStep(currentStep);
        }
    }
});

document.getElementById('prevBtn').addEventListener('click', function() {
    if (currentStep > 1) {
        currentStep--;
        showStep(currentStep);
    }
});

// Fonction de sauvegarde automatique
async function saveForm() {
    const formData = new FormData(document.getElementById('ficheUrgenceForm'));
    
    try {
        const response = await fetch('{{ path('app_fiche_urgence_save') }}', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Afficher un message de confirmation discret
            const saveBtn = document.getElementById('saveBtn');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<span class="fr-icon-check-line fr-icon--sm" aria-hidden="true"></span> Sauvegardé';
            saveBtn.classList.add('fr-btn--tertiary-no-outline');
            
            setTimeout(() => {
                saveBtn.innerHTML = originalText;
                saveBtn.classList.remove('fr-btn--tertiary-no-outline');
            }, 2000);
        }
    } catch (error) {
        console.error('Erreur lors de la sauvegarde:', error);
    }
}

// Bouton de sauvegarde manuelle
document.getElementById('saveBtn').addEventListener('click', function() {
    saveForm();
});

document.getElementById('ficheUrgenceForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    try {
        const response = await fetch('{{ path('app_fiche_urgence_soumettre') }}', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Votre fiche d\'urgence a été soumise avec succès !');
            window.location.href = '{{ path('app_mes_dossiers') }}';
        } else {
            alert('Erreur : ' + (result.error || 'Une erreur est survenue'));
        }
    } catch (error) {
        alert('Erreur lors de la soumission : ' + error.message);
    }
});

// Initialiser l'affichage
showStep(1);
</script>
{% endblock %}
