{% extends 'base.html.twig' %}

{% block title %}Détail du dossier #{{ formulaire.id }} - Administration{% endblock %}

{% block body %}
<div class="fr-container fr-my-4w">
    <div class="fr-grid-row">
        <div class="fr-col-12">
            <div class="fr-mb-4w">
                <a href="{{ path('app_admin_dossiers_bts') }}" class="fr-btn fr-btn--secondary fr-btn--sm fr-btn--icon-left fr-icon-arrow-left-line">
                    Retour à la liste
                </a>
            </div>

            <h1 class="fr-h2">Dossier d'inscription BTS #{{ formulaire.id }}</h1>

            <div class="fr-grid-row fr-grid-row--gutters fr-mt-4w">
                <div class="fr-col-12 fr-col-md-6">
                    <h2 class="fr-h3 fr-mb-3w">
                        <span class="fr-icon-user-line fr-mr-1w" aria-hidden="true"></span>
                        Informations du dossier
                    </h2>
                    
                    <!-- Toutes les informations -->
                    <div class="fr-card fr-mb-2w">
                        <div class="fr-card__body">
                            <div class="fr-card__content">
                                <div class="fr-table fr-table--no-scroll">
                                    <table style="font-size: 0.875rem;">
                                        <tbody>
                                            <tr>
                                                <th scope="row" style="padding: 0.5rem 0.75rem;">Nom</th>
                                                <td style="padding: 0.5rem 0.75rem;">{{ data.nom ?? formulaire.remplitFormulaire.nom }}</td>
                                            </tr>
                                            <tr>
                                                <th scope="row" style="padding: 0.5rem 0.75rem;">Prénom</th>
                                                <td style="padding: 0.5rem 0.75rem;">{{ data.prenom ?? formulaire.remplitFormulaire.prenom }}</td>
                                            </tr>
                                            <tr>
                                                <th scope="row" style="padding: 0.5rem 0.75rem;">Email</th>
                                                <td style="padding: 0.5rem 0.75rem;">{{ data.email ?? formulaire.remplitFormulaire.email }}</td>
                                            </tr>
                                            <tr>
                                                <th scope="row" style="padding: 0.5rem 0.75rem;">Téléphone</th>
                                                <td style="padding: 0.5rem 0.75rem;">{{ data.telephone ?? formulaire.remplitFormulaire.telephone ?? '-' }}</td>
                                            </tr>
                                            <tr>
                                                <th scope="row" style="padding: 0.5rem 0.75rem;">Date de naissance</th>
                                                <td style="padding: 0.5rem 0.75rem;">{{ data.date_naissance ?? (formulaire.remplitFormulaire.dateNaissance ? formulaire.remplitFormulaire.dateNaissance|date('d/m/Y') : '-') }}</td>
                                            </tr>
                                            <tr>
                                                <th scope="row" style="padding: 0.5rem 0.75rem;">Adresse</th>
                                                <td style="padding: 0.5rem 0.75rem;">{{ data.adresse ?? formulaire.remplitFormulaire.adresse ?? '-' }}</td>
                                            </tr>
                                            <tr>
                                                <th scope="row" style="padding: 0.5rem 0.75rem;">Département</th>
                                                <td style="padding: 0.5rem 0.75rem;">{{ data.departement ?? formulaire.remplitFormulaire.departement ?? '-' }}</td>
                                            </tr>
                                            {% for key, value in data %}
                                                {% if key not in ['nom', 'prenom', 'email', 'telephone', 'date_naissance', 'adresse', 'departement', 'carte_identite_recto', 'carte_identite_verso', 'justificatif_domicile', 'releves_notes', 'carte_identite_recto_path', 'carte_identite_verso_path', 'justificatif_domicile_path', 'releves_notes_path'] %}
                                                <tr>
                                                    <th scope="row" style="padding: 0.5rem 0.75rem;">{{ key|replace({'_': ' '})|title }}</th>
                                                    <td style="padding: 0.5rem 0.75rem;">
                                                        {% if value is iterable and value is not same as(null) %}
                                                            {{ value|join(', ') }}
                                                        {% else %}
                                                            {{ value ?? '-' }}
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                                {% endif %}
                                            {% endfor %}
                                            <tr>
                                                <th scope="row" style="padding: 0.5rem 0.75rem;">Carte Identite Recto</th>
                                                <td style="padding: 0.5rem 0.75rem;">
                                                    {% if formulaire.carteIdentiteRecto %}
                                                        <a href="#" onclick="showDocumentPreview('{{ formulaire.carteIdentiteRecto }}', 'Carte d\'identité recto'); return false;" class="fr-link">
                                                            <span class="fr-icon-eye-line fr-mr-1w" aria-hidden="true"></span>
                                                            Voir le document
                                                        </a>
                                                    {% else %}
                                                        -
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            <tr>
                                                <th scope="row" style="padding: 0.5rem 0.75rem;">Carte Identite Verso</th>
                                                <td style="padding: 0.5rem 0.75rem;">
                                                    {% if formulaire.carteIdentiteVerso %}
                                                        <a href="#" onclick="showDocumentPreview('{{ formulaire.carteIdentiteVerso }}', 'Carte d\'identité verso'); return false;" class="fr-link">
                                                            <span class="fr-icon-eye-line fr-mr-1w" aria-hidden="true"></span>
                                                            Voir le document
                                                        </a>
                                                    {% else %}
                                                        -
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            <tr>
                                                <th scope="row" style="padding: 0.5rem 0.75rem;">Justificatif Domicile</th>
                                                <td style="padding: 0.5rem 0.75rem;">
                                                    {% if formulaire.justificatifDomicile %}
                                                        <a href="#" onclick="showDocumentPreview('{{ formulaire.justificatifDomicile }}', 'Justificatif de domicile'); return false;" class="fr-link">
                                                            <span class="fr-icon-eye-line fr-mr-1w" aria-hidden="true"></span>
                                                            Voir le document
                                                        </a>
                                                    {% else %}
                                                        -
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            <tr>
                                                <th scope="row" style="padding: 0.5rem 0.75rem;">Releves Notes</th>
                                                <td style="padding: 0.5rem 0.75rem;">
                                                    {% if formulaire.relevesNotes %}
                                                        <a href="#" onclick="showDocumentPreview('{{ formulaire.relevesNotes }}', 'Relevés de notes'); return false;" class="fr-link">
                                                            <span class="fr-icon-eye-line fr-mr-1w" aria-hidden="true"></span>
                                                            Voir le document
                                                        </a>
                                                    {% else %}
                                                        -
                                                    {% endif %}
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="fr-col-12 fr-col-md-6">
                    <h2 class="fr-h3 fr-mb-3w">Statut du dossier</h2>
                    
                    <!-- Statut du dossier -->
                    <div class="fr-card fr-mb-2w" style="height: fit-content;">
                        <div class="fr-card__body">
                            <div class="fr-card__content">
                                <p class="fr-mb-2w">
                                    {% if formulaire.statut == 'soumis' %}
                                        <span class="fr-badge fr-badge--warning">En attente</span>
                                    {% elseif formulaire.statut == 'validé' %}
                                        <span class="fr-badge fr-badge--success">Validé</span>
                                    {% elseif formulaire.statut == 'rejeté' %}
                                        <span class="fr-badge fr-badge--error">Rejeté</span>
                                    {% elseif formulaire.statut == 'à modifier' %}
                                        <span class="fr-badge fr-badge--warning">À modifier</span>
                                    {% else %}
                                        <span class="fr-badge">{{ formulaire.statut }}</span>
                                    {% endif %}
                                </p>

                                <dl class="fr-text--sm">
                                    <dt class="fr-text--bold">BTS :</dt>
                                    <dd class="fr-mb-1w">{{ formulaire.typeFormulaire|default('-') }}</dd>

                                    <dt class="fr-text--bold">Date de soumission :</dt>
                                    <dd class="fr-mb-1w">{{ formulaire.dateSoumission ? formulaire.dateSoumission|date('d/m/Y à H:i') : '-' }}</dd>

                                    <dt class="fr-text--bold">Dernière modification :</dt>
                                    <dd>{{ formulaire.draftUpdatedAt ? formulaire.draftUpdatedAt|date('d/m/Y à H:i') : '-' }}</dd>
                                </dl>

                                {% if formulaire.statut == 'soumis' %}
                                <div class="fr-mt-3w">
                                    <a href="{{ path('app_admin_dossier_valider', {id: formulaire.id}) }}" 
                                       class="fr-btn fr-btn--success fr-btn--icon-left fr-icon-check-line"
                                       onclick="return confirm('Êtes-vous sûr de vouloir valider ce dossier ?');">
                                        Valider le dossier
                                    </a>
                                    <a href="{{ path('app_admin_dossier_modifier', {id: formulaire.id}) }}" 
                                       class="fr-btn fr-btn--warning fr-btn--icon-left fr-icon-edit-line fr-mt-2w"
                                       onclick="return confirm('Demander des modifications au candidat pour ce dossier ?');">
                                        Demander des modifications
                                    </a>
                                    <a href="{{ path('app_admin_dossier_rejeter', {id: formulaire.id}) }}" 
                                       class="fr-btn fr-btn--error fr-btn--icon-left fr-icon-close-line fr-mt-2w"
                                       onclick="return confirm('Êtes-vous sûr de vouloir rejeter ce dossier ?');">
                                        Rejeter le dossier
                                    </a>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function showDocumentPreview(filePath, fileName) {
    const extension = filePath.split('.').pop().toLowerCase();
    
    // Créer le HTML du contenu
    let contentHtml = '';
    
    if (extension === 'pdf') {
        contentHtml = `
            <iframe src="${filePath}" style="width: 100%; height: 600px; border: 1px solid #ddd;"></iframe>
        `;
    } else if (['jpg', 'jpeg', 'png'].includes(extension)) {
        contentHtml = `
            <img src="${filePath}" alt="${fileName}" style="max-width: 100%; max-height: 600px; border: 1px solid #ddd;" />
        `;
    } else {
        contentHtml = `
            <p>Aperçu non disponible pour ce type de fichier.</p>
        `;
    }
    
    // Créer le modal complet
    const modalHtml = `
        <div id="custom-modal-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; display: flex; align-items: center; justify-content: center;">
            <div id="custom-modal-content" style="background: white; padding: 2rem; border-radius: 8px; max-width: 90vw; max-height: 90vh; overflow: auto; box-shadow: 0 8px 24px rgba(0,0,0,0.3);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 2px solid #e5e5e5; padding-bottom: 1rem;">
                    <h2 style="margin: 0; font-size: 1.5rem;">${fileName}</h2>
                    <button id="close-custom-modal" class="fr-btn fr-btn--close" style="cursor: pointer;">Fermer</button>
                </div>
                <div style="text-align: center;">
                    ${contentHtml}
                </div>
            </div>
        </div>
    `;
    
    // Supprimer l'ancien modal s'il existe
    const oldModal = document.getElementById('custom-modal-overlay');
    if (oldModal) {
        oldModal.remove();
    }
    
    // Insérer le nouveau modal
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Gérer la fermeture
    const overlay = document.getElementById('custom-modal-overlay');
    const closeBtn = document.getElementById('close-custom-modal');
    
    closeBtn.onclick = function() {
        overlay.remove();
    };
    
    overlay.onclick = function(e) {
        if (e.target === overlay) {
            overlay.remove();
        }
    };
}
</script>
{% endblock %}
