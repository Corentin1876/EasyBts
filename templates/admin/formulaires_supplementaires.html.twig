{% extends 'base.html.twig' %}

{% block title %}Formulaires Supplémentaires - Administration{% endblock %}

{% block body %}
<div class="fr-container fr-my-4w">
    <div class="fr-grid-row">
        <div class="fr-col-12">
            <h1 class="fr-h2">Gestion des formulaires supplémentaires</h1>
            
            {% for message in app.flashes('success') %}
                <div class="fr-alert fr-alert--success fr-my-2w">
                    <p>{{ message }}</p>
                </div>
            {% endfor %}

            {% for message in app.flashes('warning') %}
                <div class="fr-alert fr-alert--warning fr-my-2w">
                    <p>{{ message }}</p>
                </div>
            {% endfor %}

            <div class="fr-tabs fr-mt-4w">
                <ul class="fr-tabs__list" role="tablist" aria-label="Filtrer les formulaires">
                    <li role="presentation">
                        <button id="tabpanel-tous" class="fr-tabs__tab fr-tabs__tab--icon-left" tabindex="0" role="tab" aria-selected="true" aria-controls="tabpanel-tous-panel">
                            Tous les formulaires
                            <span class="fr-badge fr-badge--sm fr-ml-1w">{{ (adhesionsMDL|length) + (fichesUrgence|length) + (formulairesIntendance|length) }}</span>
                        </button>
                    </li>
                    <li role="presentation">
                        <button id="tabpanel-soumis" class="fr-tabs__tab fr-tabs__tab--icon-left" tabindex="-1" role="tab" aria-selected="false" aria-controls="tabpanel-soumis-panel">
                            En attente
                            <span class="fr-badge fr-badge--sm fr-badge--warning fr-ml-1w">{{ (adhesionsMDL|filter(d => d.statut == 'soumis')|length) + (fichesUrgence|filter(f => f.statut == 'soumis')|length) + (formulairesIntendance|filter(f => f.statut == 'soumis')|length) }}</span>
                        </button>
                    </li>
                    <li role="presentation">
                        <button id="tabpanel-valide" class="fr-tabs__tab fr-tabs__tab--icon-left" tabindex="-1" role="tab" aria-selected="false" aria-controls="tabpanel-valide-panel">
                            Validés
                            <span class="fr-badge fr-badge--sm fr-badge--success fr-ml-1w">{{ (adhesionsMDL|filter(d => d.statut == 'validé')|length) + (fichesUrgence|filter(f => f.statut == 'validé')|length) + (formulairesIntendance|filter(f => f.statut == 'validé')|length) }}</span>
                        </button>
                    </li>
                </ul>

                <div id="tabpanel-tous-panel" class="fr-tabs__panel fr-tabs__panel--selected" role="tabpanel" aria-labelledby="tabpanel-tous">
                    <div class="fr-table fr-mt-2w">
                        <table>
                            <thead>
                                <tr>
                                    <th scope="col">ID</th>
                                    <th scope="col">Type</th>
                                    <th scope="col">Nom</th>
                                    <th scope="col">Prénom</th>
                                    <th scope="col">Classe</th>
                                    <th scope="col">Email</th>
                                    <th scope="col">Date de soumission</th>
                                    <th scope="col">Statut</th>
                                    <th scope="col">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for adhesion in adhesionsMDL %}
                                <tr>
                                    <td>{{ adhesion.id }}</td>
                                    <td><span class="fr-badge fr-badge--purple-glycine">MDL</span></td>
                                    <td>{{ adhesion.nom }}</td>
                                    <td>{{ adhesion.prenom }}</td>
                                    <td>{{ adhesion.classe }}</td>
                                    <td>{{ adhesion.emailEtudiant }}</td>
                                    <td>{{ adhesion.dateSoumission ? adhesion.dateSoumission|date('d/m/Y H:i') : '-' }}</td>
                                    <td>
                                        {% if adhesion.statut == 'soumis' %}
                                            <span class="fr-badge fr-badge--warning">En attente</span>
                                        {% elseif adhesion.statut == 'validé' %}
                                            <span class="fr-badge fr-badge--success">Validé</span>
                                        {% elseif adhesion.statut == 'rejeté' %}
                                            <span class="fr-badge fr-badge--error">Rejeté</span>
                                        {% elseif adhesion.statut == 'à modifier' %}
                                            <span class="fr-badge fr-badge--warning">À modifier</span>
                                        {% else %}
                                            <span class="fr-badge">{{ adhesion.statut }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{{ path('app_admin_adhesion_mdl_detail', {id: adhesion.id}) }}" 
                                           class="fr-btn fr-btn--sm fr-btn--secondary fr-btn--icon-left fr-icon-eye-line"
                                           title="Voir le détail">
                                            Voir le détail
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                                {% for fiche in fichesUrgence %}
                                <tr>
                                    <td>{{ fiche.id }}</td>
                                    <td><span class="fr-badge fr-badge--green-emeraude">Fiche urgence</span></td>
                                    <td>{{ fiche.nomEtudiant }}</td>
                                    <td>{{ fiche.prenomEtudiant }}</td>
                                    <td>{{ fiche.classe }}</td>
                                    <td>{{ fiche.utilisateur.email }}</td>
                                    <td>{{ fiche.dateSoumission ? fiche.dateSoumission|date('d/m/Y H:i') : '-' }}</td>
                                    <td>
                                        {% if fiche.statut == 'soumis' %}
                                            <span class="fr-badge fr-badge--warning">En attente</span>
                                        {% elseif fiche.statut == 'validé' %}
                                            <span class="fr-badge fr-badge--success">Validé</span>
                                        {% elseif fiche.statut == 'rejeté' %}
                                            <span class="fr-badge fr-badge--error">Rejeté</span>
                                        {% elseif fiche.statut == 'à modifier' %}
                                            <span class="fr-badge fr-badge--warning">À modifier</span>
                                        {% else %}
                                            <span class="fr-badge">{{ fiche.statut }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{{ path('app_admin_fiche_urgence_detail', {id: fiche.id}) }}" 
                                           class="fr-btn fr-btn--sm fr-btn--secondary fr-btn--icon-left fr-icon-eye-line"
                                           title="Voir le détail">
                                            Voir le détail
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                                {% for formulaire in formulairesIntendance %}
                                <tr>
                                    <td>{{ formulaire.id }}</td>
                                    <td><span class="fr-badge fr-badge--blue-ecume">Intendance</span></td>
                                    <td>{{ formulaire.nomEtudiant }}</td>
                                    <td>{{ formulaire.prenomEtudiant }}</td>
                                    <td>{{ formulaire.classe }}</td>
                                    <td>{{ formulaire.utilisateur.email }}</td>
                                    <td>{{ formulaire.dateSoumission ? formulaire.dateSoumission|date('d/m/Y H:i') : '-' }}</td>
                                    <td>
                                        {% if formulaire.statut == 'soumis' %}
                                            <span class="fr-badge fr-badge--warning">En attente</span>
                                        {% elseif formulaire.statut == 'validé' %}
                                            <span class="fr-badge fr-badge--success">Validé</span>
                                        {% elseif formulaire.statut == 'rejeté' %}
                                            <span class="fr-badge fr-badge--error">Rejeté</span>
                                        {% elseif formulaire.statut == 'à modifier' %}
                                            <span class="fr-badge fr-badge--warning">À modifier</span>
                                        {% else %}
                                            <span class="fr-badge">{{ formulaire.statut }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{{ path('app_admin_formulaire_intendance_detail', {id: formulaire.id}) }}" 
                                           class="fr-btn fr-btn--sm fr-btn--secondary fr-btn--icon-left fr-icon-eye-line"
                                           title="Voir le détail">
                                            Voir le détail
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                                {% if adhesionsMDL|length == 0 and fichesUrgence|length == 0 and formulairesIntendance|length == 0 %}
                                <tr>
                                    <td colspan="9" class="fr-text--center">Aucun formulaire trouvé</td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="tabpanel-soumis-panel" class="fr-tabs__panel" role="tabpanel" aria-labelledby="tabpanel-soumis">
                    <div class="fr-table fr-mt-2w">
                        <table>
                            <thead>
                                <tr>
                                    <th scope="col">ID</th>
                                    <th scope="col">Type</th>
                                    <th scope="col">Nom</th>
                                    <th scope="col">Prénom</th>
                                    <th scope="col">Classe</th>
                                    <th scope="col">Email</th>
                                    <th scope="col">Date de soumission</th>
                                    <th scope="col">Statut</th>
                                    <th scope="col">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for adhesion in adhesionsMDL|filter(d => d.statut == 'soumis') %}
                                <tr>
                                    <td>{{ adhesion.id }}</td>
                                    <td><span class="fr-badge fr-badge--purple-glycine">MDL</span></td>
                                    <td>{{ adhesion.nom }}</td>
                                    <td>{{ adhesion.prenom }}</td>
                                    <td>{{ adhesion.classe }}</td>
                                    <td>{{ adhesion.emailEtudiant }}</td>
                                    <td>{{ adhesion.dateSoumission ? adhesion.dateSoumission|date('d/m/Y H:i') : '-' }}</td>
                                    <td><span class="fr-badge fr-badge--warning">En attente</span></td>
                                    <td>
                                        <div class="fr-btns-group fr-btns-group--inline fr-btns-group--sm">
                                            <a href="{{ path('app_admin_adhesion_mdl_valider', {id: adhesion.id}) }}" 
                                               class="fr-btn fr-btn--sm fr-btn--icon-left fr-icon-check-line"
                                               title="Valider">
                                                Valider
                                            </a>
                                            <a href="{{ path('app_admin_adhesion_mdl_modifier', {id: adhesion.id}) }}" 
                                               class="fr-btn fr-btn--sm fr-btn--secondary fr-btn--icon-left fr-icon-edit-line"
                                               title="Demander modification">
                                                Modifier
                                            </a>
                                            <a href="{{ path('app_admin_adhesion_mdl_rejeter', {id: adhesion.id}) }}" 
                                               class="fr-btn fr-btn--sm fr-btn--secondary fr-btn--icon-left fr-icon-close-line"
                                               title="Rejeter"
                                               onclick="return confirm('Êtes-vous sûr de vouloir rejeter cette adhésion ?')">
                                                Rejeter
                                            </a>
                                            {% if adhesion.photoIndividuelle %}
                                                <a href="{{ asset('uploads/photos/' ~ adhesion.photoIndividuelle) }}" 
                                                   target="_blank"
                                                   class="fr-btn fr-btn--sm fr-btn--tertiary fr-btn--icon-left fr-icon-image-line"
                                                   title="Voir la photo">
                                                    Photo
                                                </a>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                                {% for fiche in fichesUrgence|filter(f => f.statut == 'soumis') %}
                                <tr>
                                    <td>{{ fiche.id }}</td>
                                    <td><span class="fr-badge fr-badge--green-emeraude">Fiche urgence</span></td>
                                    <td>{{ fiche.nomEtudiant }}</td>
                                    <td>{{ fiche.prenomEtudiant }}</td>
                                    <td>{{ fiche.classe }}</td>
                                    <td>{{ fiche.utilisateur.email }}</td>
                                    <td>{{ fiche.dateSoumission ? fiche.dateSoumission|date('d/m/Y H:i') : '-' }}</td>
                                    <td><span class="fr-badge fr-badge--warning">En attente</span></td>
                                    <td>
                                        <div class="fr-btns-group fr-btns-group--inline fr-btns-group--sm">
                                            <a href="{{ path('app_admin_fiche_urgence_valider', {id: fiche.id}) }}" 
                                               class="fr-btn fr-btn--sm fr-btn--icon-left fr-icon-check-line"
                                               title="Valider">
                                                Valider
                                            </a>
                                            <a href="{{ path('app_admin_fiche_urgence_modifier', {id: fiche.id}) }}" 
                                               class="fr-btn fr-btn--sm fr-btn--secondary fr-btn--icon-left fr-icon-edit-line"
                                               title="Demander modification">
                                                Modifier
                                            </a>
                                            <a href="{{ path('app_admin_fiche_urgence_rejeter', {id: fiche.id}) }}" 
                                               class="fr-btn fr-btn--sm fr-btn--secondary fr-btn--icon-left fr-icon-close-line"
                                               title="Rejeter"
                                               onclick="return confirm('Êtes-vous sûr de vouloir rejeter cette fiche ?')">
                                                Rejeter
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                                {% for formulaire in formulairesIntendance|filter(f => f.statut == 'soumis') %}
                                <tr>
                                    <td>{{ formulaire.id }}</td>
                                    <td><span class="fr-badge fr-badge--blue-ecume">Intendance</span></td>
                                    <td>{{ formulaire.nomEtudiant }}</td>
                                    <td>{{ formulaire.prenomEtudiant }}</td>
                                    <td>{{ formulaire.classe }}</td>
                                    <td>{{ formulaire.utilisateur.email }}</td>
                                    <td>{{ formulaire.dateSoumission ? formulaire.dateSoumission|date('d/m/Y H:i') : '-' }}</td>
                                    <td><span class="fr-badge fr-badge--warning">En attente</span></td>
                                    <td>
                                        <div class="fr-btns-group fr-btns-group--inline fr-btns-group--sm">
                                            <a href="{{ path('app_admin_valider_formulaire_intendance', {id: formulaire.id}) }}" 
                                               class="fr-btn fr-btn--sm fr-btn--icon-left fr-icon-check-line"
                                               title="Valider">
                                                Valider
                                            </a>
                                            <a href="{{ path('app_admin_demander_modification_formulaire_intendance', {id: formulaire.id}) }}" 
                                               class="fr-btn fr-btn--sm fr-btn--secondary fr-btn--icon-left fr-icon-edit-line"
                                               title="Demander modification">
                                                Modifier
                                            </a>
                                            <a href="{{ path('app_admin_rejeter_formulaire_intendance', {id: formulaire.id}) }}" 
                                               class="fr-btn fr-btn--sm fr-btn--secondary fr-btn--icon-left fr-icon-close-line"
                                               title="Rejeter"
                                               onclick="return confirm('Êtes-vous sûr de vouloir rejeter ce formulaire ?')">
                                                Rejeter
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                                {% if adhesionsMDL|filter(d => d.statut == 'soumis')|length == 0 and fichesUrgence|filter(f => f.statut == 'soumis')|length == 0 and formulairesIntendance|filter(f => f.statut == 'soumis')|length == 0 %}
                                <tr>
                                    <td colspan="9" class="fr-text--center">Aucun formulaire en attente</td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="tabpanel-valide-panel" class="fr-tabs__panel" role="tabpanel" aria-labelledby="tabpanel-valide">
                    <div class="fr-table fr-mt-2w">
                        <table>
                            <thead>
                                <tr>
                                    <th scope="col">ID</th>
                                    <th scope="col">Type</th>
                                    <th scope="col">Nom</th>
                                    <th scope="col">Prénom</th>
                                    <th scope="col">Classe</th>
                                    <th scope="col">Email</th>
                                    <th scope="col">Date de soumission</th>
                                    <th scope="col">Statut</th>
                                    <th scope="col">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for adhesion in adhesionsMDL|filter(d => d.statut == 'validé') %}
                                <tr>
                                    <td>{{ adhesion.id }}</td>
                                    <td><span class="fr-badge fr-badge--purple-glycine">MDL</span></td>
                                    <td>{{ adhesion.nom }}</td>
                                    <td>{{ adhesion.prenom }}</td>
                                    <td>{{ adhesion.classe }}</td>
                                    <td>{{ adhesion.emailEtudiant }}</td>
                                    <td>{{ adhesion.dateSoumission ? adhesion.dateSoumission|date('d/m/Y H:i') : '-' }}</td>
                                    <td><span class="fr-badge fr-badge--success">Validé</span></td>
                                    <td>
                                        {% if adhesion.photoIndividuelle %}
                                            <a href="{{ asset('uploads/photos/' ~ adhesion.photoIndividuelle) }}" 
                                               target="_blank"
                                               class="fr-btn fr-btn--sm fr-btn--tertiary fr-btn--icon-left fr-icon-image-line"
                                               title="Voir la photo">
                                                Photo
                                            </a>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                                {% for fiche in fichesUrgence|filter(f => f.statut == 'validé') %}
                                <tr>
                                    <td>{{ fiche.id }}</td>
                                    <td><span class="fr-badge fr-badge--green-emeraude">Fiche urgence</span></td>
                                    <td>{{ fiche.nomEtudiant }}</td>
                                    <td>{{ fiche.prenomEtudiant }}</td>
                                    <td>{{ fiche.classe }}</td>
                                    <td>{{ fiche.utilisateur.email }}</td>
                                    <td>{{ fiche.dateSoumission ? fiche.dateSoumission|date('d/m/Y H:i') : '-' }}</td>
                                    <td><span class="fr-badge fr-badge--success">Validé</span></td>
                                    <td>
                                        <a href="{{ path('app_admin_fiche_urgence_detail', {id: fiche.id}) }}" 
                                           class="fr-btn fr-btn--sm fr-btn--secondary fr-btn--icon-left fr-icon-eye-line"
                                           title="Voir le détail">
                                            Voir
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                                {% for formulaire in formulairesIntendance|filter(f => f.statut == 'validé') %}
                                <tr>
                                    <td>{{ formulaire.id }}</td>
                                    <td><span class="fr-badge fr-badge--blue-ecume">Intendance</span></td>
                                    <td>{{ formulaire.nomEtudiant }}</td>
                                    <td>{{ formulaire.prenomEtudiant }}</td>
                                    <td>{{ formulaire.classe }}</td>
                                    <td>{{ formulaire.utilisateur.email }}</td>
                                    <td>{{ formulaire.dateSoumission ? formulaire.dateSoumission|date('d/m/Y H:i') : '-' }}</td>
                                    <td><span class="fr-badge fr-badge--success">Validé</span></td>
                                    <td>
                                        <a href="{{ path('app_admin_formulaire_intendance_detail', {id: formulaire.id}) }}" 
                                           class="fr-btn fr-btn--sm fr-btn--secondary fr-btn--icon-left fr-icon-eye-line"
                                           title="Voir le détail">
                                            Voir
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                                {% if adhesionsMDL|filter(d => d.statut == 'validé')|length == 0 and fichesUrgence|filter(f => f.statut == 'validé')|length == 0 and formulairesIntendance|filter(f => f.statut == 'validé')|length == 0 %}
                                <tr>
                                    <td colspan="9" class="fr-text--center">Aucun formulaire validé</td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="fr-mt-4w">
                <a href="{{ path('app_home') }}" class="fr-btn fr-btn--secondary fr-btn--icon-left fr-icon-arrow-left-line">
                    Retour à l'accueil
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Réinitialiser manuellement les tabs si DSFR ne fonctionne pas
            const tabs = document.querySelectorAll('[role="tab"]');
            const panels = document.querySelectorAll('[role="tabpanel"]');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Désactiver tous les tabs
                    tabs.forEach(t => {
                        t.setAttribute('aria-selected', 'false');
                        t.setAttribute('tabindex', '-1');
                        t.classList.remove('fr-tabs__tab--selected');
                    });
                    
                    // Masquer tous les panels
                    panels.forEach(p => {
                        p.classList.remove('fr-tabs__panel--selected');
                        p.style.display = 'none';
                    });
                    
                    // Activer le tab cliqué
                    this.setAttribute('aria-selected', 'true');
                    this.setAttribute('tabindex', '0');
                    this.classList.add('fr-tabs__tab--selected');
                    
                    // Afficher le panel correspondant
                    const panelId = this.getAttribute('aria-controls');
                    const panel = document.getElementById(panelId);
                    if (panel) {
                        panel.classList.add('fr-tabs__panel--selected');
                        panel.style.display = 'block';
                    }
                });
            });
        });
    </script>
{% endblock %}
