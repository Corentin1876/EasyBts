{% extends 'base.html.twig' %}

{% block title %}Gestion des cookies - Inscription BTS{% endblock %}

{% block body %}
<div class="fr-container fr-py-6w" style="min-height: 60vh;">
    <div class="fr-grid-row fr-grid-row--center">
        <div class="fr-col-12 fr-col-md-10">
            <!-- Fil d'Ariane -->
            <nav class="fr-breadcrumb" aria-label="vous êtes ici :">
                <button class="fr-breadcrumb__button" aria-expanded="false" aria-controls="breadcrumb-cookies">
                    Voir le fil d'Ariane
                </button>
                <div class="fr-collapse" id="breadcrumb-cookies">
                    <ol class="fr-breadcrumb__list">
                        <li><a class="fr-breadcrumb__link" href="{{ path('app_home') }}">Accueil</a></li>
                        <li><a class="fr-breadcrumb__link" aria-current="page">Gestion des cookies</a></li>
                    </ol>
                </div>
            </nav>
            
            <!-- Titre principal -->
            <h1 class="fr-h1">Gestion des cookies</h1>
            <p class="fr-text--lead">
                Nous utilisons des cookies pour améliorer votre expérience sur notre site. 
                Vous pouvez gérer vos préférences à tout moment.
            </p>
            
            <!-- Message d'information -->
            <div class="fr-alert fr-alert--info fr-my-4w">
                <h3 class="fr-alert__title">À quoi servent les cookies ?</h3>
                <p>
                    Les cookies nous permettent de mémoriser vos préférences et d'analyser 
                    l'utilisation de notre site pour l'améliorer.
                </p>
            </div>
            
            <!-- Définition -->
            <h2 class="fr-h2">Qu'est-ce qu'un cookie ?</h2>
            <p>
                Un cookie est un petit fichier texte stocké par votre navigateur lors de la visite 
                d'un site web. Il permet de conserver des informations sur votre navigation et vos préférences.
            </p>
            
            <!-- Types de cookies -->
            <h2 class="fr-h2">Types de cookies utilisés</h2>
            
            <div class="fr-accordions-group">
                <!-- Cookies essentiels -->
                <section class="fr-accordion">
                    <h3 class="fr-accordion__title">
                        <button class="fr-accordion__btn" aria-expanded="false" aria-controls="accordion-essentiels">
                            Cookies essentiels
                        </button>
                    </h3>
                    <div class="fr-collapse" id="accordion-essentiels">
                        <div class="fr-accordion__body">
                            <div class="fr-accordion__inner">
                                <dl class="fr-dl">
                                    <dt>Objectif :</dt>
                                    <dd>Fonctionnement du site</dd>
                                    <dt>Durée :</dt>
                                    <dd>Session ou 30 jours</dd>
                                    <dt>Consentement :</dt>
                                    <dd>Non requis (indispensables)</dd>
                                    <dt>Exemples :</dt>
                                    <dd>Authentification, panier, préférences de langue</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- Cookies d'analyse -->
                <section class="fr-accordion">
                    <h3 class="fr-accordion__title">
                        <button class="fr-accordion__btn" aria-expanded="false" aria-controls="accordion-analyse">
                            Cookies de mesure d'audience
                        </button>
                    </h3>
                    <div class="fr-collapse" id="accordion-analyse">
                        <div class="fr-accordion__body">
                            <div class="fr-accordion__inner">
                                <dl class="fr-dl">
                                    <dt>Objectif :</dt>
                                    <dd>Statistiques de fréquentation</dd>
                                    <dt>Durée :</dt>
                                    <dd>13 mois</dd>
                                    <dt>Consentement :</dt>
                                    <dd>Requis</dd>
                                    <dt>Outil :</dt>
                                    <dd>AT Internet (solution française)</dd>
                                    <dt>Données :</dt>
                                    <dd>Pages visitées, durée de session, origine du trafic</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- Cookies de préférences -->
                <section class="fr-accordion">
                    <h3 class="fr-accordion__title">
                        <button class="fr-accordion__btn" aria-expanded="false" aria-controls="accordion-preferences">
                            Cookies de préférences
                        </button>
                    </h3>
                    <div class="fr-collapse" id="accordion-preferences">
                        <div class="fr-accordion__body">
                            <div class="fr-accordion__inner">
                                <dl class="fr-dl">
                                    <dt>Objectif :</dt>
                                    <dd>Mémoriser vos choix</dd>
                                    <dt>Durée :</dt>
                                    <dd>6 mois à 1 an</dd>
                                    <dt>Consentement :</dt>
                                    <dd>Requis</dd>
                                    <dt>Exemples :</dt>
                                    <dd>Thème d'affichage, choix de cookies</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
            
            <!-- Paramètres des cookies -->
            <h2 class="fr-h2 fr-mt-6w">Gérer vos cookies</h2>

            <form class="fr-form fr-my-4w" id="cookie-preferences-form">
                <fieldset class="fr-fieldset">
                    <legend class="fr-fieldset__legend">
                        Vos préférences
                    </legend>
                    <div class="fr-fieldset__content">
                        <!-- Cookies essentiels -->
                        <div class="fr-checkbox-group">
                            <input type="checkbox" id="cookies-essential" name="cookies-essential" checked disabled>
                            <label class="fr-label" for="cookies-essential">
                                Cookies essentiels
                                <span class="fr-hint-text">Indispensables au fonctionnement du site</span>
                            </label>
                        </div>

                        <!-- Cookies d'analyse -->
                        <div class="fr-checkbox-group">
                            <input type="checkbox" id="cookies-analytics" name="cookies-analytics">
                            <label class="fr-label" for="cookies-analytics">
                                Cookies de mesure d'audience
                                <span class="fr-hint-text">Nous aident à améliorer le site</span>
                            </label>
                        </div>

                        <!-- Cookies de préférences -->
                        <div class="fr-checkbox-group">
                            <input type="checkbox" id="cookies-preferences" name="cookies-preferences">
                            <label class="fr-label" for="cookies-preferences">
                                Cookies de préférences
                                <span class="fr-hint-text">Mémorisent vos choix</span>
                            </label>
                        </div>
                    </div>
                </fieldset>

                <!-- Boutons d'action -->
                <div class="fr-btns-group fr-btns-group--inline-sm fr-mt-3w">
                    <button type="button" class="fr-btn" id="save-preferences">
                        Enregistrer
                    </button>
                    <button type="button" class="fr-btn fr-btn--secondary" id="accept-all">
                        Tout accepter
                    </button>
                    <button type="button" class="fr-btn fr-btn--tertiary" id="refuse-all">
                        Tout refuser
                    </button>
                </div>
            </form>
            
            <!-- Configuration navigateur -->
            <h2 class="fr-h2 fr-mt-6w">Paramétrer votre navigateur</h2>
            <div class="fr-callout fr-callout--brown-caramel fr-my-3w">
                <p class="fr-callout__text">
                    Vous pouvez également configurer directement votre navigateur pour gérer les cookies.
                    Consultez les paramètres de confidentialité de votre navigateur (Chrome, Firefox, Safari, Edge).
                </p>
            </div>
            
            <!-- Tableau des cookies -->
            <h2 class="fr-h2 fr-mt-6w">Liste des cookies</h2>
            <div class="fr-table fr-my-3w">
                <table>
                    <caption>Cookies utilisés sur le site</caption>
                    <thead>
                        <tr>
                            <th scope="col">Nom</th>
                            <th scope="col">Finalité</th>
                            <th scope="col">Durée</th>
                            <th scope="col">Type</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>PHPSESSID</code></td>
                            <td>Session utilisateur</td>
                            <td>Session</td>
                            <td>Essentiel</td>
                        </tr>
                        <tr>
                            <td><code>cookie_consent</code></td>
                            <td>Choix cookies</td>
                            <td>1 an</td>
                            <td>Essentiel</td>
                        </tr>
                        <tr>
                            <td><code>user_preferences</code></td>
                            <td>Préférences</td>
                            <td>1 an</td>
                            <td>Préférences</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Contact -->
            <div class="fr-callout fr-my-4w">
                <h3 class="fr-callout__title">Questions ?</h3>
                <p class="fr-callout__text">
                    Pour toute question sur les cookies : <a href="mailto:dpo@education.gouv.fr">dpo@education.gouv.fr</a>
                    ou via notre <a href="{{ path('app_contact') }}">formulaire de contact</a>.
                </p>
                <p class="fr-text--xs fr-mt-2w">Dernière mise à jour : {{ "now"|date("d/m/Y") }}</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Éléments DOM
    const analyticsCheckbox = document.getElementById('cookies-analytics');
    const preferencesCheckbox = document.getElementById('cookies-preferences');
    const saveBtn = document.getElementById('save-preferences');
    const acceptAllBtn = document.getElementById('accept-all');
    const refuseAllBtn = document.getElementById('refuse-all');
    
    // Fonctions utilitaires pour les cookies
    function setCookie(name, value, days) {
        const expires = new Date(Date.now() + days * 864e5).toUTCString();
        document.cookie = `${name}=${encodeURIComponent(value)}; expires=${expires}; path=/; SameSite=Strict`;
    }
    
    function getCookie(name) {
        return document.cookie.split('; ').reduce((r, v) => {
            const parts = v.split('=');
            return parts[0] === name ? decodeURIComponent(parts[1]) : r;
        }, '');
    }
    
    function showNotification(message, type = 'success') {
        const notification = document.createElement('div');
        notification.className = `fr-alert fr-alert--${type} fr-alert--sm`;
        notification.innerHTML = `<p class="fr-alert__title">${message}</p>`;
        
        const container = document.querySelector('.fr-container');
        container.insertBefore(notification, container.firstChild);
        
        // Scroll vers le haut pour voir la notification
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 4000);
    }
    
    function savePreferences() {
        const preferences = {
            analytics: analyticsCheckbox.checked,
            preferences: preferencesCheckbox.checked,
            timestamp: Date.now()
        };
        
        setCookie('cookie_consent', JSON.stringify(preferences), 365);
        showNotification('Vos préférences ont été enregistrées');
        
        setTimeout(() => {
            window.location.reload();
        }, 2000);
    }
    
    // Gestionnaires d'événements
    saveBtn.addEventListener('click', savePreferences);
    
    acceptAllBtn.addEventListener('click', function() {
        analyticsCheckbox.checked = true;
        preferencesCheckbox.checked = true;
        savePreferences();
    });
    
    refuseAllBtn.addEventListener('click', function() {
        analyticsCheckbox.checked = false;
        preferencesCheckbox.checked = false;
        savePreferences();
    });
    
    // Charger les préférences existantes
    const existingConsent = getCookie('cookie_consent');
    if (existingConsent) {
        try {
            const preferences = JSON.parse(existingConsent);
            analyticsCheckbox.checked = preferences.analytics || false;
            preferencesCheckbox.checked = preferences.preferences || false;
        } catch (e) {
            console.warn('Erreur lors du chargement des préférences cookies:', e);
        }
    }
});
</script>
{% endblock %}