{% extends 'base.html.twig' %}

{% block title %}Adhésion MDL{% endblock %}

{% block body %}
<!-- Fil d'ariane -->
<nav class="fr-breadcrumb" aria-label="vous êtes ici :">
    <button class="fr-breadcrumb__button" aria-expanded="false" aria-controls="breadcrumb-mdl">Voir le fil d'Ariane</button>
    <div class="fr-collapse" id="breadcrumb-mdl">
        <ol class="fr-breadcrumb__list">
            <li><a class="fr-breadcrumb__link" href="{{ path('app_home') }}">Accueil</a></li>
            <li><a class="fr-breadcrumb__link" href="{{ path('app_mes_dossiers') }}">Mes dossiers</a></li>
            <li><a class="fr-breadcrumb__link" aria-current="page">Adhésion MDL</a></li>
        </ol>
    </div>
</nav>

<!-- En-tête -->
<section class="fr-container fr-py-6v">
    <div class="fr-grid-row">
        <div class="fr-col-12">
            <h1 class="fr-h1">Adhésion à la Maison Des Lycéens (MDL)</h1>
            <p class="fr-text--lead fr-mb-3v">
                Complétez ce formulaire pour adhérer à la MDL et participer à la vie associative de l'établissement.
            </p>
            <div class="fr-alert fr-alert--info fr-mb-4v">
                <p class="fr-text--sm">Votre progression est enregistrée automatiquement. Vous pouvez revenir plus tard pour compléter le formulaire.</p>
            </div>
        </div>
    </div>
</section>

<!-- Indicateur de progression -->
<section class="fr-container fr-mb-4v">
    <div class="fr-stepper" id="stepper">
        <h2 class="fr-stepper__title">
            <span class="fr-stepper__state">Étape <span id="current-step">1</span> sur 4</span>
        </h2>
        <div class="fr-stepper__steps" data-fr-current-step="1" data-fr-steps="4" id="stepper-progress"></div>
        <p class="fr-stepper__details">
            <span class="fr-text--bold" id="step-title">Informations de l'étudiant</span>
        </p>
    </div>
</section>

<!-- Formulaire d'adhésion -->
<section class="fr-container fr-pb-6v">
    <form class="fr-form" id="adhesionForm" method="post">
        
        <!-- Étape 1: Informations de l'étudiant -->
        <div class="form-step" id="step-1">
            <div class="fr-card">
                <div class="fr-card__body">
                    <h2 class="fr-h2 fr-mb-3v">Informations de l'étudiant</h2>

                    <div class="fr-grid-row fr-grid-row--gutters">
                        <div class="fr-col-12 fr-col-md-6">
                            <div class="fr-input-group">
                                <label class="fr-label" for="nom">Nom <span class="fr-text--red">*</span></label>
                                <input class="fr-input" type="text" id="nom" name="nom" value="{{ defaultData.nom ?? adhesion.nom ?? '' }}" required>
                            </div>
                        </div>
                        <div class="fr-col-12 fr-col-md-6">
                            <div class="fr-input-group">
                                <label class="fr-label" for="prenom">Prénom <span class="fr-text--red">*</span></label>
                                <input class="fr-input" type="text" id="prenom" name="prenom" value="{{ defaultData.prenom ?? adhesion.prenom ?? '' }}" required>
                            </div>
                        </div>
                    </div>

                    <div class="fr-grid-row fr-grid-row--gutters">
                        <div class="fr-col-12 fr-col-md-6">
                            <div class="fr-input-group">
                                <label class="fr-label" for="classe">Classe <span class="fr-text--red">*</span></label>
                                <input class="fr-input" type="text" id="classe" name="classe" value="{{ adhesion.classe ?? '' }}" placeholder="Ex: BTS CG 1ère année" required>
                            </div>
                        </div>
                        <div class="fr-col-12 fr-col-md-6">
                            <div class="fr-input-group">
                                <label class="fr-label" for="date_naissance">Date de naissance <span class="fr-text--red">*</span></label>
                                <input class="fr-input" type="date" id="date_naissance" name="date_naissance" value="{{ defaultData.date_naissance ?? (adhesion.dateNaissance ? adhesion.dateNaissance|date('Y-m-d') : '') }}" required>
                            </div>
                        </div>
                    </div>

                    <div class="fr-input-group">
                        <label class="fr-label" for="email_etudiant">Email étudiant <span class="fr-text--red">*</span></label>
                        <input class="fr-input" type="email" id="email_etudiant" name="email_etudiant" value="{{ defaultData.email_etudiant ?? adhesion.emailEtudiant ?? '' }}" required>
                    </div>
                </div>
            </div>
        </div>

        <!-- Étape 2: Responsable légal -->
        <div class="form-step" id="step-2" style="display: none;">
            <div class="fr-card">
                <div class="fr-card__body">
                    <h2 class="fr-h2 fr-mb-3v">Responsable légal</h2>

                    <div class="fr-input-group">
                        <label class="fr-label" for="nom_responsable">Nom du responsable <span class="fr-text--red">*</span></label>
                        <input class="fr-input" type="text" id="nom_responsable" name="nom_responsable" value="{{ adhesion.nomResponsable ?? '' }}" required>
                    </div>

                    <div class="fr-input-group">
                        <label class="fr-label" for="adresse_responsable">Adresse du responsable <span class="fr-text--red">*</span></label>
                        <textarea class="fr-input" id="adresse_responsable" name="adresse_responsable" rows="3" required>{{ adhesion.adresseResponsable ?? '' }}</textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- Étape 3: Modalités de paiement et photo -->
        <div class="form-step" id="step-3" style="display: none;">
            <div class="fr-card fr-mb-4v">
                <div class="fr-card__body">
                    <h2 class="fr-h2 fr-mb-3v">Modalités de paiement</h2>

                    <fieldset class="fr-fieldset">
                        <legend class="fr-fieldset__legend">Type de paiement <span class="fr-text--red">*</span></legend>
                        <div class="fr-fieldset__content">
                            <div class="fr-radio-group">
                                <input type="radio" id="paiement-especes" name="type_paiement" value="especes" {% if adhesion.typePaiement == 'especes' %}checked{% endif %} required>
                                <label class="fr-label" for="paiement-especes">Espèces</label>
                            </div>
                            <div class="fr-radio-group">
                                <input type="radio" id="paiement-cheque" name="type_paiement" value="cheque" {% if adhesion.typePaiement == 'cheque' %}checked{% endif %}>
                                <label class="fr-label" for="paiement-cheque">Chèque</label>
                            </div>
                            <div class="fr-radio-group">
                                <input type="radio" id="paiement-cb" name="type_paiement" value="carte_bancaire" {% if adhesion.typePaiement == 'carte_bancaire' %}checked{% endif %}>
                                <label class="fr-label" for="paiement-cb">Carte bancaire</label>
                            </div>
                            <div class="fr-radio-group">
                                <input type="radio" id="paiement-virement" name="type_paiement" value="virement" {% if adhesion.typePaiement == 'virement' %}checked{% endif %}>
                                <label class="fr-label" for="paiement-virement">Virement</label>
                            </div>
                        </div>
                    </fieldset>
                </div>
            </div>

            <div class="fr-card">
                <div class="fr-card__body">
                    <h2 class="fr-h2 fr-mb-3v">Photo individuelle</h2>

                    <div class="fr-upload-group">
                        <label class="fr-label" for="photo">
                            Photo d'identité <span class="fr-text--red">*</span>
                            <span class="fr-hint-text">Format JPG, PNG. Taille max : 2 Mo</span>
                        </label>
                        <input class="fr-upload" type="file" id="photo" name="photo" accept="image/jpeg,image/png">
                        {% if adhesion.photoIndividuelle %}
                        <p class="fr-text--sm fr-mt-2v">
                            <span class="fr-icon-check-line" aria-hidden="true"></span>
                            Photo téléchargée : {{ adhesion.photoIndividuelle }}
                        </p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Étape 4: Autorisation et validation -->
        <div class="form-step" id="step-4" style="display: none;">
            <div class="fr-card">
                <div class="fr-card__body">
                    <h2 class="fr-h2 fr-mb-3v">Autorisation et validation</h2>

                    <div class="fr-checkbox-group">
                        <input type="checkbox" id="autorisation_droit_image" name="autorisation_droit_image" value="1" {% if adhesion.autorisationDroitImage %}checked{% endif %}>
                        <label class="fr-label" for="autorisation_droit_image">
                            J'autorise l'utilisation de mon image dans le cadre des activités de la MDL
                        </label>
                    </div>

                    <div class="fr-checkbox-group fr-mt-3v">
                        <input type="checkbox" id="certif_exact" name="certif_exact" required>
                        <label class="fr-label" for="certif_exact">
                            Je certifie que les informations fournies sont exactes <span class="fr-text--red">*</span>
                        </label>
                    </div>

                    <div class="fr-alert fr-alert--info fr-mt-3v">
                        <p class="fr-text--sm">
                            <strong>Note :</strong> Une fois votre adhésion soumise, vous recevrez une confirmation.
                            Votre adhésion sera examinée par les services de la MDL.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Boutons de navigation -->
        <div class="fr-btns-group fr-btns-group--inline-md fr-mt-4v">
            <button class="fr-btn fr-btn--secondary" type="button" id="btn-previous" style="display: none;">
                Étape précédente
            </button>
            <button class="fr-btn fr-btn--secondary" type="button" id="btn-save">
                <span class="fr-icon-save-line fr-icon--sm" aria-hidden="true"></span>
                Sauvegarder et continuer plus tard
            </button>
            <button class="fr-btn" type="button" id="btn-next">
                Étape suivante
            </button>
            <button class="fr-btn" type="submit" id="btn-submit" style="display: none;">
                Soumettre mon adhésion
            </button>
        </div>
    </form>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('adhesionForm');
    const btnNext = document.getElementById('btn-next');
    const btnPrevious = document.getElementById('btn-previous');
    const btnSave = document.getElementById('btn-save');
    const btnSubmit = document.getElementById('btn-submit');
    const photoInput = document.getElementById('photo');
    
    let currentStep = 1;
    const totalSteps = 4;
    
    // Gestion des étapes
    function showStep(stepNumber) {
        // Cacher toutes les étapes
        document.querySelectorAll('.form-step').forEach(step => {
            step.style.display = 'none';
        });
        
        // Afficher l'étape courante
        document.getElementById('step-' + stepNumber).style.display = 'block';
        
        // Mettre à jour l'indicateur
        document.getElementById('current-step').textContent = stepNumber;
        
        // Mettre à jour la barre de progression
        const stepperProgress = document.getElementById('stepper-progress');
        stepperProgress.setAttribute('data-fr-current-step', stepNumber);
        
        // Mettre à jour les titres d'étapes
        const titles = [
            'Informations de l\'étudiant',
            'Responsable légal',
            'Modalités de paiement et photo',
            'Autorisation et validation'
        ];
        document.getElementById('step-title').textContent = titles[stepNumber - 1];
        
        // Gérer la visibilité des boutons
        btnPrevious.style.display = stepNumber > 1 ? 'inline-block' : 'none';
        btnNext.style.display = stepNumber < totalSteps ? 'inline-block' : 'none';
        btnSubmit.style.display = stepNumber === totalSteps ? 'inline-block' : 'none';
        
        currentStep = stepNumber;
    }
    
    // Validation d'une étape
    function validateStep(stepNumber) {
        const stepElement = document.getElementById('step-' + stepNumber);
        const inputs = stepElement.querySelectorAll('input[required], textarea[required], select[required]');
        const radios = stepElement.querySelectorAll('input[type="radio"][required]');
        
        let isValid = true;
        let firstInvalid = null;
        
        // Vérifier les champs normaux
        inputs.forEach(input => {
            if (input.type !== 'radio' && input.type !== 'checkbox') {
                if (!input.value.trim()) {
                    isValid = false;
                    input.classList.add('fr-input--error');
                    if (!firstInvalid) firstInvalid = input;
                } else {
                    input.classList.remove('fr-input--error');
                }
            }
        });
        
        // Vérifier les groupes de boutons radio
        const radioGroups = {};
        radios.forEach(radio => {
            if (!radioGroups[radio.name]) {
                radioGroups[radio.name] = [];
            }
            radioGroups[radio.name].push(radio);
        });
        
        Object.keys(radioGroups).forEach(groupName => {
            const group = radioGroups[groupName];
            const isChecked = group.some(radio => radio.checked);
            if (!isChecked) {
                isValid = false;
                group.forEach(radio => {
                    const label = radio.closest('.fr-radio-group');
                    if (label && !firstInvalid) firstInvalid = radio;
                });
            }
        });
        
        if (!isValid && firstInvalid) {
            firstInvalid.focus();
            alert('Veuillez remplir tous les champs obligatoires avant de continuer.');
        }
        
        return isValid;
    }
    
    // Bouton suivant
    btnNext.addEventListener('click', function() {
        if (validateStep(currentStep) && currentStep < totalSteps) {
            showStep(currentStep + 1);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    });
    
    // Bouton précédent
    btnPrevious.addEventListener('click', function() {
        if (currentStep > 1) {
            showStep(currentStep - 1);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    });
    
    // Sauvegarde
    btnSave.addEventListener('click', function() {
        const formData = new FormData(form);
        
        fetch('{{ path('app_adhesion_mdl_save') }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Données sauvegardées avec succès');
            }
        })
        .catch(error => console.error('Erreur:', error));
    });

    // Upload photo
    photoInput.addEventListener('change', function() {
        if (this.files.length > 0) {
            const formData = new FormData();
            formData.append('photo', this.files[0]);
            
            fetch('{{ path('app_adhesion_mdl_upload_photo') }}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Photo téléchargée avec succès');
                }
            })
            .catch(error => console.error('Erreur:', error));
        }
    });

    // Soumission
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (!form.checkValidity()) {
            alert('Veuillez remplir tous les champs obligatoires');
            return;
        }
        
        // Sauvegarder d'abord
        const formData = new FormData(form);
        fetch('{{ path('app_adhesion_mdl_save') }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Puis soumettre
                return fetch('{{ path('app_adhesion_mdl_submit') }}', {
                    method: 'POST'
                });
            }
        })
        .then(() => {
            window.location.href = '{{ path('app_mes_dossiers') }}';
        })
        .catch(error => console.error('Erreur:', error));
    });
    
    // Initialiser à l'étape 1
    showStep(1);
});
</script>
{% endblock %}