{% extends 'base.html.twig' %}

{% block title %}Adhésion MDL{% endblock %}

{% block body %}
<!-- Fil d'ariane -->
<nav class="fr-breadcrumb" aria-label="vous êtes ici :">
    <button class="fr-breadcrumb__button" aria-expanded="false" aria-controls="breadcrumb-mdl">Voir le fil d'Ariane</button>
    <div class="fr-collapse" id="breadcrumb-mdl">
        <ol class="fr-breadcrumb__list">
            <li><a class="fr-breadcrumb__link" href="{{ path('app_home') }}">Accueil</a></li>
            <li><a class="fr-breadcrumb__link" href="{{ path('app_mes_dossiers') }}">Mes dossiers</a></li>
            <li><a class="fr-breadcrumb__link" aria-current="page">Adhésion MDL</a></li>
        </ol>
    </div>
</nav>

<!-- En-tête -->
<section class="fr-container fr-py-6v">
    <div class="fr-grid-row">
        <div class="fr-col-12">
            <h1 class="fr-h1">Adhésion à la Maison Des Lycéens (MDL)</h1>
            <p class="fr-text--lead fr-mb-3v">
                Complétez ce formulaire pour adhérer à la MDL et participer à la vie associative de l'établissement.
            </p>
            
            {% for message in app.flashes('warning') %}
                <div class="fr-alert fr-alert--warning fr-mb-4v">
                    <p><strong>{{ message }}</strong></p>
                </div>
            {% endfor %}
            
            <div class="fr-alert fr-alert--info fr-mb-4v">
                <p class="fr-text--sm">Votre progression est enregistrée automatiquement. Vous pouvez revenir plus tard pour compléter le formulaire.</p>
            </div>
        </div>
    </div>
</section>

<!-- Indicateur de progression -->
<section class="fr-container fr-mb-4v">
    <div class="fr-stepper" id="stepper">
        <h2 class="fr-stepper__title">
            <span class="fr-stepper__state">Étape <span id="current-step">1</span> sur 4</span>
        </h2>
        <div class="fr-stepper__steps" data-fr-current-step="1" data-fr-steps="4" id="stepper-progress"></div>
        <p class="fr-stepper__details">
            <span class="fr-text--bold" id="step-title">Informations de l'étudiant</span>
        </p>
    </div>
</section>

<!-- Formulaire d'adhésion -->
<section class="fr-container fr-pb-6v">
    <form class="fr-form" id="adhesionForm" method="post">
        
        <!-- Étape 1: Informations de l'étudiant -->
        <div class="form-step" id="step-1">
            <div class="fr-card">
                <div class="fr-card__body">
                    <h2 class="fr-h2 fr-mb-3v">Informations de l'étudiant</h2>

                    <div class="fr-grid-row fr-grid-row--gutters">
                        <div class="fr-col-12 fr-col-md-6">
                            <div class="fr-input-group">
                                <label class="fr-label" for="nom">Nom <span class="fr-text--red">*</span></label>
                                <input class="fr-input" type="text" id="nom" name="nom" value="{{ defaultData.nom ?? adhesion.nom ?? '' }}" required>
                            </div>
                        </div>
                        <div class="fr-col-12 fr-col-md-6">
                            <div class="fr-input-group">
                                <label class="fr-label" for="prenom">Prénom <span class="fr-text--red">*</span></label>
                                <input class="fr-input" type="text" id="prenom" name="prenom" value="{{ defaultData.prenom ?? adhesion.prenom ?? '' }}" required>
                            </div>
                        </div>
                    </div>

                    <div class="fr-grid-row fr-grid-row--gutters">
                        <div class="fr-col-12 fr-col-md-6">
                            <div class="fr-input-group">
                                <label class="fr-label" for="classe">Classe <span class="fr-text--red">*</span></label>
                                <input class="fr-input" type="text" id="classe" name="classe" value="{{ adhesion.classe ?? '' }}" placeholder="Ex: BTS CG 1ère année" required>
                            </div>
                        </div>
                        <div class="fr-col-12 fr-col-md-6">
                            <div class="fr-input-group">
                                <label class="fr-label" for="date_naissance">Date de naissance <span class="fr-text--red">*</span></label>
                                <input class="fr-input" type="date" id="date_naissance" name="date_naissance" value="{{ defaultData.date_naissance ?? (adhesion.dateNaissance ? adhesion.dateNaissance|date('Y-m-d') : '') }}" required>
                            </div>
                        </div>
                    </div>

                    <div class="fr-grid-row fr-grid-row--gutters">
                        <div class="fr-col-12 fr-col-md-6">
                            <div class="fr-input-group">
                                <label class="fr-label" for="email_etudiant">Email étudiant <span class="fr-text--red">*</span></label>
                                <input class="fr-input" type="email" id="email_etudiant" name="email_etudiant" value="{{ defaultData.email_etudiant ?? adhesion.emailEtudiant ?? '' }}" required>
                            </div>
                        </div>
                        <div class="fr-col-12 fr-col-md-6">
                            <div class="fr-input-group">
                                <label class="fr-label" for="telephone_etudiant">Téléphone étudiant <span class="fr-text--red">*</span></label>
                                <input class="fr-input" type="tel" id="telephone_etudiant" name="telephone_etudiant" value="{{ adhesion.telephoneEtudiant ?? '' }}" required placeholder="06 12 34 56 78" pattern="[0-9\s]{10,14}">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Étape 2: Responsable légal -->
        <div class="form-step" id="step-2" style="display: none;">
            <div class="fr-card">
                <div class="fr-card__body">
                    <h2 class="fr-h2 fr-mb-3v">Responsable légal</h2>

                    <div class="fr-input-group">
                        <label class="fr-label" for="nom_responsable">Nom du responsable <span class="fr-text--red">*</span></label>
                        <input class="fr-input" type="text" id="nom_responsable" name="nom_responsable" value="{{ adhesion.nomResponsable ?? '' }}" required>
                    </div>

                    <div class="fr-input-group">
                        <label class="fr-label" for="adresse_responsable">Adresse du responsable <span class="fr-text--red">*</span></label>
                        <textarea class="fr-input" id="adresse_responsable" name="adresse_responsable" rows="3" required>{{ adhesion.adresseResponsable ?? '' }}</textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- Étape 3: Modalités de paiement et photo -->
        <div class="form-step" id="step-3" style="display: none;">
            <div class="fr-card fr-mb-4v">
                <div class="fr-card__body">
                    <h2 class="fr-h2 fr-mb-3v">Modalités de paiement</h2>

                    <div class="fr-select-group">
                        <label class="fr-label" for="type_paiement">Type de paiement <span class="fr-text--red">*</span></label>
                        <select class="fr-select" id="type_paiement" name="type_paiement" required>
                            <option value="" selected disabled>Sélectionner un mode de paiement</option>
                            <option value="especes" {% if adhesion.typePaiement == 'especes' %}selected{% endif %}>Espèces</option>
                            <option value="cheque" {% if adhesion.typePaiement == 'cheque' %}selected{% endif %}>Chèque</option>
                            <option value="carte_bancaire" {% if adhesion.typePaiement == 'carte_bancaire' %}selected{% endif %}>Carte bancaire</option>
                            <option value="virement" {% if adhesion.typePaiement == 'virement' %}selected{% endif %}>Virement</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="fr-card">
                <div class="fr-card__body">
                    <h2 class="fr-h2 fr-mb-3v">Photo individuelle</h2>

                    <div class="fr-upload-group" id="upload-photo-group">
                        <label class="fr-label" for="photo">
                            Photo d'identité <span class="fr-text--red">*</span>
                            <span class="fr-hint-text">Format JPG, PNG. Taille max : 2 Mo</span>
                        </label>
                        <div class="uploaded-file-info" style="display:none; margin-bottom: 0.5rem;">
                            <span class="fr-icon-check-circle-fill fr-icon--sm" style="color: green;" aria-hidden="true"></span>
                            <a href="#" class="file-name photo-preview-link" style="text-decoration: underline; margin: 0 0.5rem;"></a>
                            <button type="button" class="fr-btn fr-btn--tertiary-no-outline fr-btn--sm change-photo-btn">Changer</button>
                        </div>
                        <input class="fr-upload" type="file" id="photo" name="photo" accept="image/jpeg,image/png" required>
                    </div>
                </div>
            </div>
        </div>

        <!-- Étape 4: Autorisation et validation -->
        <div class="form-step" id="step-4" style="display: none;">
            <div class="fr-card">
                <div class="fr-card__body">
                    <h2 class="fr-h2 fr-mb-3v">Autorisation et validation</h2>

                    <div class="fr-checkbox-group">
                        <input type="checkbox" id="autorisation_droit_image" name="autorisation_droit_image" value="1" {% if adhesion.autorisationDroitImage %}checked{% endif %}>
                        <label class="fr-label" for="autorisation_droit_image">
                            J'autorise l'utilisation de mon image dans le cadre des activités de la MDL
                        </label>
                    </div>

                    <div class="fr-checkbox-group fr-mt-3v">
                        <input type="checkbox" id="certif_exact" name="certif_exact" required>
                        <label class="fr-label" for="certif_exact">
                            Je certifie que les informations fournies sont exactes <span class="fr-text--red">*</span>
                        </label>
                    </div>

                    <div class="fr-alert fr-alert--info fr-mt-3v">
                        <p class="fr-text--sm">
                            <strong>Note :</strong> Une fois votre adhésion soumise, vous recevrez une confirmation.
                            Votre adhésion sera examinée par l'administration.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Boutons de navigation -->
        <div class="fr-btns-group fr-btns-group--inline-md fr-mt-4v">
            <button class="fr-btn fr-btn--secondary" type="button" id="btn-previous" style="display: none;">
                Étape précédente
            </button>
            <button class="fr-btn fr-btn--secondary" type="button" id="btn-save">
                <span class="fr-icon-save-line fr-icon--sm" aria-hidden="true"></span>
                Sauvegarder et continuer plus tard
            </button>
            <button class="fr-btn" type="button" id="btn-next">
                Étape suivante
            </button>
            <button class="fr-btn" type="submit" id="btn-submit" style="display: none;">
                Soumettre mon adhésion
            </button>
        </div>
    </form>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('adhesionForm');
    const btnNext = document.getElementById('btn-next');
    const btnPrevious = document.getElementById('btn-previous');
    const btnSave = document.getElementById('btn-save');
    const btnSubmit = document.getElementById('btn-submit');
    const photoInput = document.getElementById('photo');
    
    let currentStep = 1;
    const totalSteps = 4;
    
    // Gestion des étapes
    function showStep(stepNumber) {
        // Cacher toutes les étapes
        document.querySelectorAll('.form-step').forEach(step => {
            step.style.display = 'none';
        });
        
        // Afficher l'étape courante
        document.getElementById('step-' + stepNumber).style.display = 'block';
        
        // Mettre à jour l'indicateur
        document.getElementById('current-step').textContent = stepNumber;
        
        // Mettre à jour la barre de progression
        const stepperProgress = document.getElementById('stepper-progress');
        stepperProgress.setAttribute('data-fr-current-step', stepNumber);
        
        // Mettre à jour les titres d'étapes
        const titles = [
            'Informations de l\'étudiant',
            'Responsable légal',
            'Modalités de paiement et photo',
            'Autorisation et validation'
        ];
        document.getElementById('step-title').textContent = titles[stepNumber - 1];
        
        // Gérer la visibilité des boutons
        btnPrevious.style.display = stepNumber > 1 ? 'inline-block' : 'none';
        btnNext.style.display = stepNumber < totalSteps ? 'inline-block' : 'none';
        btnSubmit.style.display = stepNumber === totalSteps ? 'inline-block' : 'none';
        
        currentStep = stepNumber;
    }
    
    // Validation d'une étape
    function validateStep(stepNumber) {
        const stepElement = document.getElementById('step-' + stepNumber);
        const inputs = stepElement.querySelectorAll('input[required], textarea[required], select[required]');
        
        let isValid = true;
        let firstInvalid = null;
        
        // Vérifier tous les champs requis
        inputs.forEach(input => {
            // Ignorer les champs cachés
            if (input.style.display === 'none' || input.offsetParent === null) {
                return;
            }
            
            let isEmpty = false;
            
            if (input.type === 'checkbox') {
                isEmpty = !input.checked;
            } else if (input.type === 'radio') {
                // Pour les radios, on vérifie si au moins un du groupe est coché
                const radioName = input.name;
                const radios = stepElement.querySelectorAll(`input[type="radio"][name="${radioName}"]`);
                isEmpty = !Array.from(radios).some(r => r.checked);
            } else if (input.tagName === 'SELECT') {
                isEmpty = !input.value || input.value === '';
            } else {
                isEmpty = !input.value.trim();
            }
            
            if (isEmpty) {
                isValid = false;
                if (input.classList) {
                    input.classList.add('fr-input--error');
                    input.classList.add('fr-select--error');
                }
                if (!firstInvalid) firstInvalid = input;
            } else {
                if (input.classList) {
                    input.classList.remove('fr-input--error');
                    input.classList.remove('fr-select--error');
                }
            }
        });
        
        if (!isValid && firstInvalid) {
            firstInvalid.focus();
            alert('Veuillez remplir tous les champs obligatoires avant de continuer.');
        }
        
        return isValid;
    }
    
    // Bouton suivant
    btnNext.addEventListener('click', function() {
        if (validateStep(currentStep) && currentStep < totalSteps) {
            showStep(currentStep + 1);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    });
    
    // Bouton précédent
    btnPrevious.addEventListener('click', function() {
        if (currentStep > 1) {
            showStep(currentStep - 1);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    });
    
    // Sauvegarde
    btnSave.addEventListener('click', function() {
        const formData = new FormData(form);
        
        fetch('{{ path('app_adhesion_mdl_save') }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Données sauvegardées avec succès');
            }
        })
        .catch(error => console.error('Erreur:', error));
    });

    // Fonction pour afficher l'aperçu d'une photo
    function showPhotoPreview(filePath, fileName) {
        const modalHtml = `
            <div id="photo-modal-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; display: flex; align-items: center; justify-content: center;">
                <div id="photo-modal-content" style="background: white; padding: 2rem; border-radius: 8px; max-width: 90vw; max-height: 90vh; overflow: auto; box-shadow: 0 8px 24px rgba(0,0,0,0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 2px solid #e5e5e5; padding-bottom: 1rem;">
                        <h2 style="margin: 0; font-size: 1.5rem;">Aperçu de la photo</h2>
                        <button id="close-photo-modal" class="fr-btn fr-btn--close" style="cursor: pointer;">Fermer</button>
                    </div>
                    <div style="text-align: center;">
                        <img src="${filePath}" alt="${fileName}" style="max-width: 100%; max-height: 600px; border: 1px solid #ddd;" />
                    </div>
                </div>
            </div>
        `;
        
        const oldModal = document.getElementById('photo-modal-overlay');
        if (oldModal) {
            oldModal.remove();
        }
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        const overlay = document.getElementById('photo-modal-overlay');
        const closeBtn = document.getElementById('close-photo-modal');
        
        closeBtn.onclick = function() {
            overlay.remove();
        };
        
        overlay.onclick = function(e) {
            if (e.target === overlay) {
                overlay.remove();
            }
        };
    }

    // Fonction pour marquer la photo comme uploadée
    function markPhotoAsUploaded(filePath) {
        console.log('markPhotoAsUploaded appelé avec:', filePath);
        const group = document.getElementById('upload-photo-group');
        if (!group) {
            console.error('Groupe upload-photo-group non trouvé');
            return;
        }
        
        const fileInfo = group.querySelector('.uploaded-file-info');
        const photoInput = document.getElementById('photo');
        const fileName = filePath.split('/').pop();
        
        if (fileInfo && photoInput) {
            const fileLink = fileInfo.querySelector('.file-name');
            if (!fileLink) {
                console.error('Lien fichier non trouvé');
                return;
            }
            
            fileLink.textContent = fileName;
            fileLink.href = '#';
            fileLink.onclick = function(e) {
                e.preventDefault();
                showPhotoPreview(filePath, fileName);
                return false;
            };
            
            fileInfo.style.display = 'block';
            photoInput.style.display = 'none';
            photoInput.removeAttribute('required');
            
            const changeBtn = fileInfo.querySelector('.change-photo-btn');
            if (changeBtn) {
                changeBtn.onclick = function() {
                    fileInfo.style.display = 'none';
                    photoInput.style.display = 'block';
                    photoInput.value = '';
                };
            }
            console.log('Photo marquée comme uploadée:', fileName);
        } else {
            console.error('Elements non trouvés - fileInfo:', fileInfo, 'photoInput:', photoInput);
        }
    }

    // Upload photo
    if (photoInput) {
        photoInput.addEventListener('change', function() {
            if (this.files.length > 0) {
                console.log('Upload de la photo:', this.files[0].name);
                const formData = new FormData();
                formData.append('photo', this.files[0]);
                
                fetch('{{ path('app_adhesion_mdl_upload_photo') }}', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Réponse upload photo:', data);
                    if (data.success && data.path) {
                        markPhotoAsUploaded(data.path);
                    } else {
                        alert('Erreur lors de l\'upload de la photo: ' + (data.error || 'Erreur inconnue'));
                        photoInput.value = '';
                    }
                })
                .catch(error => {
                    console.error('Erreur upload:', error);
                    alert('Erreur lors de l\'upload de la photo');
                    photoInput.value = '';
                });
            }
        });
    } else {
        console.error('Element photoInput non trouvé');
    }

    // Soumission
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (!form.checkValidity()) {
            alert('Veuillez remplir tous les champs obligatoires');
            return;
        }
        
        // Sauvegarder d'abord
        const formData = new FormData(form);
        fetch('{{ path('app_adhesion_mdl_save') }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Puis soumettre
                return fetch('{{ path('app_adhesion_mdl_submit') }}', {
                    method: 'POST'
                });
            }
        })
        .then(() => {
            window.location.href = '{{ path('app_mes_dossiers') }}';
        })
        .catch(error => console.error('Erreur:', error));
    });
    
    // Charger la photo existante si elle existe
    {% if adhesion and adhesion.photoIndividuelle %}
        console.log('Photo existante d\u00e9tect\u00e9e:', '{{ adhesion.photoIndividuelle }}');
        markPhotoAsUploaded('/uploads/photos/{{ adhesion.photoIndividuelle }}');
    {% endif %}
    
    // Initialiser à l'étape 1
    showStep(1);
});
</script>
{% endblock %}